# ИДЗ-1. Работа с массивами
## Евсеев Евгений Васильевич. Вариант 18.

# Оглавление

### Введение
- [О программе](#01-immediate.s)
    - [Представленные файлы](#01-immediate.s)
    - [Функции и локальные переменные в ASM](#fdsfd)
- [О тестировании](#01-immediate.s)
### Отчет
- [Mark 4](#01-immediate.s)
- [Mark 5](#02-register.s)
- [Mark 6](#03-memory.s)
- [Mark 7](#04-constToMemory.s)
- [Mark 8](#05-jumps.s)
- [Mark 9](#05-jumps.s)

### Прочее
- [Checklist](#05-jumps.s)


# Введение
## О программе
Программа сразу разрабатывалась с учетом всех требований включительно до 9.
Поэтому, с самого начала присутствуем разделение на модули, работа с файлами и прочее
### Представленные файлы
- `d`
- `d`
- `d`
- `d`
- `d`
- `d`
### [Функции и локальные переменные в ASM](#fdsfd)

## О тестировании
Тестирование Ручное для пределов



# Mark 4
- [ASM код исходника на С](/c-source/) 
- [АSM код с комментариями](/asm-source/)




Для получения изначального ASM кода

TODO: проверить команды, тестирование range, написать о программе и диапозонах
```
gcc -masm=intel \
    -fno-asynchronous-unwind-tables \
    -fno-jump-tables \
    -fno-stack-protector \
    -fno-exceptions \
    ./c-source/*.c \
    -S 
```

Макросов в полученных ASM файлах не оказалось.
Удалил служебные метки GCC в конце, сложно их назвать макросами, но это лишний код


Для компиляции обоих программ: 
```
gcc *.s
```

Резльтаты тестовых прогонов обоих программ на одинаковых наборах случайных данных
``` 
python3 tests/main.py c-source/a.out task-1/a.out
```
```
✓ c-source/a.out:       Console Tests passed
✓ task-1/a.out: Console Tests passed
✓ c-source/a.out:       File Tests passed
✓ task-1/a.out: File Tests passed
```

# Mark 5
Все требуемые комментарии были написаны при выполнении пункта Mark 4. Каких-либо дополнительныз действий для выполнения Mark 5 не потребовалась
Изменений не было

# Mark 6
Task 2

Файл main.s остался не тронутым. В main не происходит никаких вычисление или работы с массивом, в следствии чего, разница в скорости выполнения при хранении данных в регситрах не будет. Не было сделано, так как мы ограничены кол-вом регистров

Так же, в некоторых места получилось переписать обращение к `array[i]` - вместо 5 строчеу, с вычислением смещения в массиве и обращением, получилось `mov rdx, DWORD r11[rax*4]`

|Функция|Использованы регистры|Дополнительно|
|--- |---|---|
|process_array|`i => r8`, `&array => rdi`, `size => esi`|На стеке больше ничего не хранится| 
|read_array_from_console|`&array => r15`, `max_size => r14`, `i => r13`|Выделяется меньше памяти на стеке|
|print_array|`&array => r15`, `size => r14`, `i => r13`|На стеке больше ничего не хранится|
|read_array_from_file|`&filepath => rsi`, `&array => r15`, `max_size => r14`|Выделяется в два раза меньше памяти на стеке|
|save_array_to_file|`&filepath => rdx`, `&array => r15`, `size => r14`|Выделяется в три раза меньше памяти на стеке|
|random_fill_array|`&array => r15`, `size => r14`, `seed => edx`||



В итоге, программа использует следующие регистры:
|Регистр|Используется|
|---|---|
|r13|`consoleio: i`|
|r13|`random: arra_size`, `fileio: array_size (print), max_size (read)`, `consoleio: size (print)`|
|r15|`random: &array`, `fileio: &array`, `consoleio: &array`|
|==|   |
|rsi|`fileio: filepath`|
|r8|`arrayprocessor: i`|
|r9|`random: seed`|


## Тестовые прогоны:
Принимали участие:
- `/c-source/a.out` - исходник
- `/task-1/a.out` - с комментариями
- `/task-2/a.out` - с регистрами


Резльтаты тестовых прогонов обоих программ на одинаковых наборах случайных данных
``` 
python3 tests/main.py c-source/a.out task-1/a.out task-2/a.out
```
```
Running tests on executables: c-source/a.out, task-1/a.out, task-2/a.out
Running 300 tests on each executable...
✓ c-source/a.out:       Console Tests passed
✓ task-1/a.out: Console Tests passed
✓ task-2/a.out: Console Tests passed
✓ c-source/a.out:       File Tests passed
✓ task-1/a.out: File Tests passed
✓ task-2/a.out: File Tests passed

Running stress tests on each executable... 
c-source/a.out: 6.630322 seconds
task-1/a.out:   6.650191 seconds
task-2/a.out:   1.121077 seconds
```

# Оценка 7
С самого начла разрабатывалась с учетом нескольких единиц компиляции
TODO: результаты работы с файлами


### Оценка 8
TODO: [ ] Представить полученные данные в отчете для разных вариантов тестовых прогонов



# Mark 9
|Программа|Размер ASM кода (байт)|Размер исполняемого файла (байт)|Результат стресс-теста (сек)|
|---|---|---|---|
|c-source/a.out|12260|17712|6.642092|
|Task-1|26692|17456|6.641976|
|Task-2|26914|17320|1.120018|
|O0|12260|17664|6.661868|
|O1|9431|17696|1.170315|
|O2|9927|17696|1.054121|
|O3|9927|17696|1.055933|
|Ofast|9927|19280|1.059444|
|Os|8727|17696|1.176046|


gcc *.c -masm=intel -fno-asynchronous-unwind-tables -fno-jump-tables -fno-stack-protector -fno-exceptions -o ../bins/os.out -Os


TODO: исправить аргументы в комментариях

# ## save_array_to_file()
# ### Локальные перменные
# - QWORD -16[rbp]    - &out_file
# - QWORD -24[rbp]    - &array
# - DWORD -28[rbp]    - size
# - QWORD -40[rbp]    - &filepath
# ### Параметры и возвращаемый результат
# - rdi - &array
# - rsi - &filepath
# - edx - size

	mov	QWORD PTR -24[rbp], rdi		# / сохранение аргументов, &array
	mov	DWORD PTR -28[rbp], esi		# | size
	# mov	QWORD PTR -40[rbp], rdx		# \ filepath



# Функции и локальные переменные
### main()
#### Локальные перменные
```
- DWORD -4[rbp]     - array_size
- DWORD -8[rbp]     - rand_seed
- DWORD -12[rbp]    - input_mode
- DWORD -16[rbp]    - clocks_elapsed
- DWORD -20[rbp]    - i
- QWORD -32[rbp]    - file_path
- QWORD -40[rbp]    - start_time 
- QWORD -48[rbp]    - end_time
- DWORD -52[rbp]    - количество аргументов запуска
- QWORD -64[rbp]    - указатель на аргументы
```
#### Параметры и возвращаемый результат
```
- edi - argc
- rsi - argc
- rax (return) - exit code
```

### random_fill_array()
#### Локальные перменные
```
- DWORD -4[rbp]     - i
- QWORD -24[rbp]	- &array
- DWORD -28[rbp]    - size
- DWORD -32[rbp]	- seed
```
#### Параметры и возвращаемый результат
```
- rdi - &array
- esi - size
- edx - seed
- rax (return) - array_size
```

### process_array()
#### Локальные перменные
```
- DWORD -4[rbp]     - i
- QWORD -24[rbp]    - &array
- DWORD -28[rbp]    - size
```
#### Параметры и возвращаемый результат
```
- rdi - &array
- esi - size
```
### read_array_from_console()
#### Локальные перменные
```
- DWORD -4[rbp]     - i
- DWORD -8[rbp]     - n
- QWORD -24[rbp]    - &array
- DWORD -28[rbp]    - max_size
```
#### Параметры и возвращаемый результат
```
- rdi - &array
- esi - max_size
- rax (return) - array_size
```

### print_array()
#### Локальные перменные
```
- DWORD -4[rbp]     - i
- QWORD -24[rbp]    - &array
- DWORD -28[rbp]    - size
```
#### Параметры и возвращаемый результат
```
- rdi - &array
- esi - size
```
### read_array_from_file()
#### Локальные перменные
```
- DWORD -4[rbp]     - i
- QWORD -16[rbp]    - &in_file
- DWORD -20[rbp]    - n
- QWORD -40[rbp]    - &array
- QWORD -48[rbp]    - &filepath
- DWORD -52[rbp]    - max_size
```
#### Параметры и возвращаемый результат
```
- rdi - &array
- rsi - &filepath
- edx - max_size
- rax (return) - array_size
```
### save_array_to_file()
#### Локальные перменные
```
- QWORD -16[rbp]    - &out_file
- QWORD -24[rbp]    - &array
- DWORD -28[rbp]    - size
- QWORD -40[rbp]    - &filepath
```
#### Параметры и возвращаемый результат
```
- rdi - &array
- rsi - &filepath
- edx - size
```


# Checklist
### Оценка 4
- [x] Приведено решение задачи на C.
- [x] В полученную ассемблерную программу, откомпилированную без оптимизирующих и отладочных опций, добавлены комментарии, поясняющие
эквивалентное представление переменных в программе на C.
- [x] Из ассемблерной программы убраны лишние макросы за счет использования соответствующих аргументов командной строки и/или за счет
ручного редактирования исходного текста ассемблерной программы.
- [x] Модифицированная ассемблерная программа отдельно откомпилирована
и скомпонована без использования опций отладки.
- [x] Представлено полное тестовое покрытие, дающее одинаковый результат
на обоих программах. Приведены результаты тестовых прогонов для обоих программ, демонстрирующие эквивалентность функционирования.
- [x] Сформировать отчет, описывающий результаты тестовых прогонов и используемых опций компиляции и/или описания проведенных модификаций.

### Оценка 5
- [x] В реализованной программе использовать функции с передачей данных
через параметры.
- [x] Использовать локальные переменные.
- [x?] В ассемблерную программу при вызове функции добавить комментарии,
описывающие передачу фактических параметров и перенос возвращаемого результата.
- [x] В функциях для формальных параметров добавить комментарии, описывающие связь между параметрами языка Си и регистрами (стеком).
- [x] Добавить информацию о проведенных изменениях в отчет.

### Оценка 6

- [x] Рефакторинг программы на ассемблере за счет максимального использования регистров процессора. Добавление этой программы к уже представленным.
- [x] Добавление комментариев в разработанную программу, поясняющих эквивалентное использование регистров вместо переменных исходной программы на C.
- [x] Представление результатов тестовых прогонов для разработанной программы. Оценка корректности ее выполнения на основе сравнения тестовых прогонов результатами тестирования предшествующих программ.
- [x] Добавить новую информацию в отчет


### Оценка 7
- [x] Реализация программы на ассемблере, полученной после рефакторинга,
в виде двух или более единиц компиляции.
- [x] Задание файлов с исходными данными и файла для вывода результатов
с использованием аргументов командной строки.
- [ ] Добавить в отчет информацию о проделанных изменениях и результаты
работы с тестовыми файлами.

### Оценка 8
- [x] Добавление в программу генератора случайных наборов данных, расширяющих возможности тестирования. Подключение генератора к программе с выбором в командной строке варианта ввода данных.
- [x] Расширение анализа командной строки для выбора способа порождения
исходных данных. Добавление данных, порождаемых генератором.
- [x] Модификация программы на C и программы на ассемблере, полученной
после рефакторинга, для проведения сравнения на производительность.
Необходимо добавить замеры во времени, которые не учитывают время
ввода и вывода данных. Для увеличения времени работы минимум до 1
секунды, в зависимости от особенностей программы, можно либо выбирать соответствующие размеры исходных данных, либо зацикливать для
многократного выполнения ту часть программы, которая выполняет вычисления.
- [ ] Представить полученные данные в отчете для разных вариантов тестовых прогонов

### Оценка 9
- [x] Используя опции оптимизации по скорости, сформировать из модифицированной программы на C исходный код ассемблере. Провести сравнительный анализ с предыдущими ассемблерными программами по размеру ассемблерного кода, размеру исполняемого файла и производительности.
- [x] Аналогично, используя опции оптимизации по размеру, сформировать
код на ассемблере. Провести сравнительный анализ с предыдущими ассемблерными программами по размеру ассемблерного кода, размеру исполняемого файла и производительности.
- [ ] Представить в отчете полученные результаты, дополнив данные представленные в предыдущем отчете.

### Оценка 10
- [ ] Избавиться от инфляции